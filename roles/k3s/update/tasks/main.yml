---
- name: Install/Update K3s on Control Plane
  shell: |
    curl -sfL https://get.k3s.io | sh -s - server \
    --write-kubeconfig-mode 644
  when: "'ControlPlane' in group_names"
  notify:
    - Restart K3s on Control Plane

- name: Install/Update K3s on Worker Nodes
  shell: |
    curl -sfL https://get.k3s.io | K3S_URL=https://{{ hostvars[groups['ControlPlane'][0]].ansible_host }}:6443 K3S_TOKEN={{ k3s_token }} sh -
  when: "'WorkerNodes' in group_names"
  notify:
    - Restart K3s on Worker Nodes
